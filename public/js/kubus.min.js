jQuery(document).ready(function(){$(window.applicationCache).bind("updateready",function(){window.applicationCache.swapCache()})}),function(e){"use strict";e.BUILDER=e.BUILDER||{};var t=e.BUILDER;t.ConstructionArea=function(e,n,i){function r(){if(!(e instanceof jQuery))throw new Error;for(var t=0;t<n.length;t++)if(!(n[t]instanceof jQuery))throw new Error;z.forEach(function(e){requestAnimationFrame(function(){THREE.ImageUtils.loadTexture(F.path+e.toUpperCase().substring(1)+F.extention,void 0,function(t){N[e]=t})})}),O.setCubeMaterial("#FBE430"),V=jQuery.Event("updateView"),E=50,R=[],D=[],T=new THREE.BoxGeometry(E,E,E),x=new THREE.Raycaster,S=new THREE.Vector2,B=new THREE.Vector2,w=250,v(),y=h(),b=l(),H=d(e,!0),P=new THREE.OrbitControls(b,H.domElement),P.noPan=!0,o(),e.append(H.domElement),e[0].addEventListener("mousedown",g),e[0].addEventListener("mouseup",g),u(),setTimeout(function(){f()},1e3)}function o(){P.maxDistance=w/2*20,P.minDistance=w,P.reset()}function a(e){if(Math.round(e.point.z)<w&&Math.round(e.point.z)>0-w&&Math.round(e.point.x)<w&&Math.round(e.point.x)>0-w&&Math.round(e.point.y)<E*(w/(E/2))){var t=new THREE.Mesh(T,C),n=e.face.normal.clone().multiplyScalar(E/2);if(t.position.copy(e.point).add(n),w/(E/2)%2!==0){var i=t.position.y;t.position.divideScalar(E).round().multiplyScalar(E),t.position.y=Math.abs(Math.floor(i/E)*E+E/2)}else t.position.divideScalar(E).floor().multiplyScalar(E).addScalar(E/2);t.position.y>0&&!s(t.position)&&(y.add(t),R.push(t),k=6,setTimeout(function(){m()},0))}}function s(e){for(var t=1;t<R.length;t++)if(e.equals(R[t].position))return!0;return!1}function l(){var t=new THREE.PerspectiveCamera(45,e.width()/e.height(),1,1e4);return t.position.set(500,800,1300),t.lookAt(new THREE.Vector3),t}function c(){var e=[],t=w/7,n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(w+t,0,w)),n.vertices.push(new THREE.Vector3(w+t,0,-w));var i=new THREE.LineBasicMaterial({color:39236,linewidth:2});e.push(new THREE.Line(n,i,THREE.LinePieces));var n=new THREE.Geometry;return n.vertices.push(new THREE.Vector3(-(w+t),0,w)),n.vertices.push(new THREE.Vector3(-(w+t),0,-w)),i=new THREE.LineBasicMaterial({color:14842878,linewidth:2}),e.push(new THREE.Line(n,i,THREE.LinePieces)),n=new THREE.Geometry,n.vertices.push(new THREE.Vector3(w,0,w+t)),n.vertices.push(new THREE.Vector3(-w,0,w+t)),i=new THREE.LineBasicMaterial({color:26807,linewidth:2}),e.push(new THREE.Line(n,i,THREE.LinePieces)),n=new THREE.Geometry,n.vertices.push(new THREE.Vector3(w,0,-(w+t))),n.vertices.push(new THREE.Vector3(-w,0,-(w+t))),i=new THREE.LineBasicMaterial({color:15964160,linewidth:2}),e.push(new THREE.Line(n,i,THREE.LinePieces)),e}function u(){function e(e,n,i,r){var o=1200,a=r.width()/r.height(),s=new THREE.OrthographicCamera(a*o/2,-a*o/2,o/2,-o/2);s.position.set(e,n,i),s.lookAt(new THREE.Vector3(0,w,0));var l=d(r);return new t.View(l,s,r,y,w)}D=[],D.push(e(0,1600,0,n[0])),D.push(e(0,w,w,n[1])),D.push(e(-w,w,0,n[2])),D.push(e(0,w,-w,n[3])),D.push(e(w,w,0,n[4])),n[5]&&D.push(e(0,1600,0,n[5])),D.forEach(function(e){e.init()})}function d(e,t){t=t||!1;var n;return n=t&&Detector.webgl?new THREE.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}):new THREE.CanvasRenderer({alpha:!0}),n.setClearColor(0,0),n.setPixelRatio(window.devicePixelRatio||1),n.setSize(e.width(),e.height()),n}function h(){var e=new THREE.Scene;return e.add(M),e.add(L),c().forEach(function(t){e.add(t)}),e}function p(e){e.object!=L&&(y.remove(e.object),R.splice(R.indexOf(e.object),1),k=6,setTimeout(function(){m()},0))}function f(){requestAnimationFrame(f),H.render(y,b)}function v(){for(var e=new THREE.Geometry,t=-w;w>=t;t+=E)e.vertices.push(new THREE.Vector3(-w,0,t)),e.vertices.push(new THREE.Vector3(w,0,t)),e.vertices.push(new THREE.Vector3(t,0,-w)),e.vertices.push(new THREE.Vector3(t,0,w));var n=new THREE.LineBasicMaterial({color:0,opacity:.2,transparent:!0});M=new THREE.Line(e,n,THREE.LinePieces);var i=new THREE.PlaneBufferGeometry(2*w,2*w);i.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));var r=new THREE.Mesh(i);r.visible=Detector.webgl?!1:!1,R[0]=r,L=r}function m(){var e=1==R.length?"0":R.length-1,t=$("#counter");t.length&&t.text(e)}function g(t){t.preventDefault();var n={x:t.pageX-e.offset().left,y:t.pageY-e.offset().top};if("mousedown"===t.type)S.x=n.x,S.y=n.y;else if("mouseup"===t.type){if(S.x!=n.x||S.y!=n.y)return;B.set(n.x/e.width()*2-1,2*-(n.y/e.height())+1),x.setFromCamera(B,b);var i=x.intersectObjects(R);if(i.length>0){var r=i[0];switch(t.button){case 0:I?a(r):p(r);break;case 2:p(r)}}}}var E,w,R,T,y,b,H,C,x,S,B,M,L,P,D,V,I=!0,O=this,z=i||[],N={},A={},k=0,F={extention:".png",path:"public/img/textures/"};this.perspective=function(){},this.clearCubes=function(){for(var e=1;e<R.length;e++)y.remove(R[e]);R.splice(1,R.length),m()},this.enableOrDisableOrbit=function(e){return"boolean"==typeof e?(P.enabled=e,!0):!1},this.loadModel=function(e){var t,n,i=C;t="object"==typeof e?e:JSON.parse(e),t=JSON.parse(LZString.decompressFromBase64(t.model)),R=[],w=t.baseSize*(E/2),v(),y=h();for(var r=0,o=t.cubes.length;o>r;r++){var a="#"+t.cubes[r].color;O.setCubeMaterial(a),n=new THREE.Mesh(T,A[a]),n.position.x=t.cubes[r].x,n.position.y=t.cubes[r].y,n.position.z=t.cubes[r].z,y.add(n),R.push(n)}m(),u(),O.renderPerspectives(),C=i},this.renderPerspectives=function(){D.forEach(function(e){e.setSize(),e.render()})},this.resize=function(){b.aspect=e.width()/e.height(),b.updateProjectionMatrix(),H.setSize(e.width(),e.height()),O.renderPerspectives()},this.saveModel=function(){function e(e,t,n,i){this.color=e,this.x=t,this.y=n,this.z=i}for(var t={baseSize:R[0].geometry.parameters.height/E,cubes:[],step:E/2},n=1;n<R.length;n++){var i=R[n].material.map.sourceFile;i=i.replace("public/img/textures/",""),i=i.replace(".png",""),t.cubes.push(new e(i,R[n].position.x,R[n].position.y,R[n].position.z))}return LZString.compressToBase64(JSON.stringify(t))},this.setBaseSize=function(e){return!isNaN(e)&&e>=1&&10>=e?(w=E/2*e,R=[],v(),o(),y=h(),u(),m(),k=6,!0):!1},this.getBaseSize=function(){var e=w/(E/2);return e},this.setCubeMaterial=function(e){var t=new RegExp("^#([A-Fa-f0-9]{6})$");return t.test(e)?(Detector.webgl?void 0==A[e]?(C=new THREE.MeshBasicMaterial({map:N[e.toUpperCase()]||THREE.ImageUtils.loadTexture(F.path+e.toUpperCase().substring(1)+F.extention)}),A[e]=C):C=A[e]:void 0==A[e]?(C=new THREE.MeshBasicMaterial({color:e}),A[e]=C):C=A[e],!0):!1},this.toggleBuildMode=function(){I=!I},this.shouldRenderPerspectives=function(e){D.forEach(function(t){t.shouldRender(e)}),D[5].shouldRender(!0)},r(),setInterval(function(){requestAnimationFrame(function(){k>0&&D[0].render()&&k--})},400),setInterval(function(){requestAnimationFrame(function(){k>0&&D[1].render()&&k--})},400),setInterval(function(){requestAnimationFrame(function(){k>0&&D[2].render()&&k--})},400),setInterval(function(){requestAnimationFrame(function(){k>0&&D[3].render()&&k--})},400),setInterval(function(){requestAnimationFrame(function(){k>0&&D[4].render()&&k--})},400),setInterval(function(){requestAnimationFrame(function(){k>0&&D[5].render()&&k--})},400)},t.View=function(e,t,n,i,r){var o=!0;this.render=function(){return o?(e.render(i,t),!0):!1},this.setSize=function(){var i=2*r-10;"topView"==n.attr("id")?i=2*r+r/20:"preview"==n.attr("id")&&(i=2*r+r/2);var o=n.width()/n.height();e.setSize(n.width(),n.height()),t.left=o*i/2,t.right=-o*i/2,t.top=i/2,t.bottom=-i/2,t.updateProjectionMatrix()},this.init=function(){n.empty(),n.append(e.domElement)},this.shouldRender=function(e){o=e}}}(window),function(e){"use strict";e.BUILDER=e.BUILDER||{};var t=e.BUILDER;t.BuildingSaver=function(){function e(e){var t={},n=0;for(var i in e){var r=new Date(e[i].date),o=new Date(r.getTime()+2592e6),a=new Date;if(a.setHours(0,0,0,0),o>=a.getTime()){if(n>=250)break;t[i]=e[i],n+=1}}return t}function t(e,t){for(var n in t)if(n=n.trim().toLowerCase(),e=e.trim().toLowerCase(),n==e)return!0;return!1}function n(e){var t=e.getDate();10>t&&(t="0"+t);var n=e.getMonth()+1;10>n&&(n="0"+n);var i=e.getFullYear();return i+"-"+n+"-"+t}function i(){return localStorage.getItem(o)?JSON.parse(localStorage.getItem(o)):!1}function r(e){localStorage.setItem(o,JSON.stringify(e))}var o="buildings",a=this;this.getBuilding=function(e){var t=i();return console.log("New"),e=e.trim().toLowerCase(),console.log(t),t?t[e]:!1},this.saveBuildings=function(n){var o=i()||{};for(var a in n)a=a.trim().toLowerCase(),t(a,o)||(o[a]=n[a]);r(e(o))},this.saveNewBuilding=function(e,r){var e=e.trim().toLowerCase();if(t(e,i()))return!1;var o={},r=LZString.compressToBase64(r),s=n(new Date);return o[e]={model:r,date:s},a.saveBuildings(o),!0}}}(window),jQuery(document).ready(function(e){function t(t){var n=t.attr("href"),i=c.getBaseSize();switch(n){case"#up":if(!(10>i))return;i=parseInt(i)+1;break;case"#down":if(!(i>1))return;i=parseInt(i)-1}e("#sizePreview").text(i),c.setBaseSize(i),c.renderPerspectives(),e("#ThreeJScontainer").trigger("updateView")}function n(t){var n=t.attr("href");void 0!=u&&e("#cube").removeClass("color-"+u.substring(1)),u=n,e("#cube").addClass("color-"+u.substring(1)),"#random"==n&&(n=a()),c.setCubeMaterial(n),i(e("#cube")),o()}function i(t){o(),t.hasClass("chosen")||(e(".buildOption").removeClass("chosen"),t.toggleClass("chosen"),c.toggleBuildMode())}function r(t){var n=t.attr("href"),i=n!==d;o(),i&&(("#save"==n||"#import"==n)&&(e("#Submit").text("#save"==n?"Spara":"Hämta"),n="#FormModal",navigator.userAgent.match(/(iPad|iPhone|iPod touch);.*CPU.*OS 7_\d/i)&&(e("#modal").css({position:"absolute",marginTop:e(window).scrollTop()+"px",bottom:"auto"}),setTimeout(function(){e("#modal").css({height:Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight)+"px"})},0))),"#help"==n&&(n="#helpModal"),e("#modal").toggleClass("open"),e(n).toggleClass("open"),e("#alert").text(""),e(".modalOption").toggleClass("faded"),t.removeClass("faded"),d=n,c.enableOrDisableOrbit(!1))}function o(){e(d).removeClass("open"),e("#modal").removeClass("open"),e(".modalOption").removeClass("faded"),e("#alert").removeClass("sadSmiley"),e("#alert").removeClass("happySmiley"),e("#Name").val(""),d=null,c.enableOrDisableOrbit(!0)}function a(){return l[Math.floor(Math.random()*(l.length-1))]}var s=[e("#topView"),e("#blueView"),e("#redView"),e("#yellowView"),e("#greenView"),e("#preview")],l=[];e("#colorsModal a").each(function(t,n){"#random"!=e(n).attr("href")&&l.push(e(n).attr("href"))});var c=new BUILDER.ConstructionArea(e("#ThreeJScontainer"),s,l);c.renderPerspectives();var u,d=null;document.querySelector("#ThreeJScontainer").addEventListener("mousedown",function(){"#random"==u&&c.setCubeMaterial(a())}),e("#toggleCounter").on("click",function(t){t.preventDefault(),"→"===e("#toggleArrow").text()?(e("#toggleArrow").text("←"),e(".counter").show()):"←"===e("#toggleArrow").text()&&(e("#toggleArrow").text("→"),e(".counter").hide())}),e("#menu").on("click","a",function(t){t.preventDefault(),e(this).hasClass("buildOption")?i(e(this)):(r(e(this)),c.renderPerspectives())}),e("#perspectives").on("click","a",function(e){e.preventDefault()}),e("#togglePerspectiveLandscape").on("click",function(t){t.preventDefault();var n=e("#togglePerspectiveLandscape"),i=e("#perspectives");n.hasClass("open")?(i.hide(),c.shouldRenderPerspectives(!1),n.attr("class","close"),n.text("←")):(i.show(),c.shouldRenderPerspectives(!0),n.attr("class","open"),n.text("→"))}),e("#togglePerspectivePortrait").on("click",function(t){t.preventDefault();var n=e("#togglePerspectivePortrait"),i=e("#perspectives");n.hasClass("open")?(i.hide(),c.shouldRenderPerspectives(!1),n.attr("class","close"),n.text("↑")):(i.show(),c.shouldRenderPerspectives(!0),n.attr("class","open"),n.text("↓"))}),e("#modal").click(function(e){"DIV"==e.target.tagName&&o()}),e("#modal").on("click","a",function(i){i.preventDefault(),e(this).hasClass("color")?n(e(this)):e(this).hasClass("sizeControl")?t(e(this)):e(this).hasClass("perspective")?setPerspective(e(this)):(("#import"==e(this).attr("href")||"#save"==e(this).attr("href"))&&(r(e(this)),e("#Name").focus()),"#print"==e(this).attr("href")&&(o(),window.print()),"#reset"==e(this).attr("href")&&(c.clearCubes(),c.renderPerspectives(),e("#ThreeJScontainer").trigger("updateView"),o()),"#help"==e(this).attr("href")&&r(e(this)))}),navigator.onLine&&e("#formOfflineInfo").hide(),e(window).on("online",function(){e("#formOfflineInfo").hide()}),e(window).on("offline",function(){e("#formOfflineInfo").show()}),e("#Submit").on("click",function(t){t.preventDefault();var n=e.trim(e("#Name").val()),i=new BUILDER.BuildingSaver,r=e("#alert");if(""==n||null==n||void 0==n)r.text("Namnet är för kort"),e("#alert").toggleClass("sadSmiley");else if(n.length<=50)if("Hämta"==e(this).text())if(navigator.onLine){var a="api/"+n;e.ajax({type:"GET",url:a,statusCode:{200:function(e){i.saveNewBuilding(n,e.data.model,!1),c.loadModel(e.data),o()},400:function(t){var t=i.getBuilding(n);t?(c.loadModel(t),o()):(r.text("Byggnaden hittades inte"),e("#alert").toggleClass("sadSmiley"))}}})}else{var s=i.getBuilding(n);s?(c.loadModel(s),o()):(r.text("Byggnaden hittades inte"),e("#alert").toggleClass("sadSmiley"))}else{var a="api/create",l=LZString.decompressFromBase64(c.saveModel());navigator.onLine?e.ajax({type:"POST",url:a,data:{name:n,model:l},statusCode:{201:function(t){i.saveBuildings(JSON.parse(t.data)),r.text("Byggnaden sparades"),e("#alert").toggleClass("happySmiley"),e("#Name").val("")},400:function(){r.text("Namnet finns redan"),e("#alert").toggleClass("sadSmiley")},503:function(){r.text("Ett fel inträffade, försök igen"),e("#alert").toggleClass("sadSmiley")}}}):i.saveNewBuilding(n,l,!0)?(r.text("Byggnaden sparades lokalt"),e("#alert").toggleClass("happySmiley"),e("#Name").val("")):(r.text("Namnet finns redan"),e("#alert").toggleClass("sadSmiley"))}else r.text("Namnet är för långt"),e("#alert").toggleClass("sadSmiley");return!1}),e(window).resize(function(){c.resize()})});
